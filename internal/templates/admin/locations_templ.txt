<!-- Header --><div class=\"flex flex-col gap-3 md:flex-row justify-between items-center w-full p-5\"><h1 class=\"text-2xl font-bold\">Locations  <span class=\"badge badge-ghost\">
</span> <span class=\"htmx-indicator loading loading-dots loading-md text-info\">Updating</span></h1><span class=\"flex md:flex-row flex-wrap justify-center gap-5\">
<div class=\"join\"><a href=\"/admin/locations/qr-codes.zip\" class=\"btn btn-base btn-outline join-item mb-3 md:mb-0\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-image-down\"><path d=\"M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21\"></path> <path d=\"m14 19 3 3v-5.5\"></path> <path d=\"m17 22 3-3\"></path> <circle cx=\"9\" cy=\"9\" r=\"2\"></circle></svg> QR codes</a> <a class=\"btn btn-base btn-outline join-item\" href=\"/admin/locations/posters.pdf\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-file-down\"><path d=\"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z\"></path> <path d=\"M14 2v4a2 2 0 0 0 2 2h4\"></path> <path d=\"M12 18v-6\"></path> <path d=\"m9 15 3 3 3-3\"></path></svg> Posters</a></div>
<a href=\"/admin/locations/new\" hx-boost=\"true\" class=\"btn btn-secondary\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-map-pin-plus w-5 h-5\"><path d=\"M19.914 11.105A7.298 7.298 0 0 0 20 10a8 8 0 0 0-16 0c0 4.993 5.539 10.193 7.399 11.799a1 1 0 0 0 1.202 0 32 32 0 0 0 .824-.738\"></path><circle cx=\"12\" cy=\"10\" r=\"3\"></circle><path d=\"M16 18h6\"></path><path d=\"M19 15v6\"></path></svg> Add Location</a></span></div><!-- Locations list --><div class=\"px-5\"><form
 class=\"join join-vertical w-full shadow sortable\"
 class=\"join join-vertical w-full shadow\"
 hx-post=\"/admin/locations/reorder\" hx-trigger=\"end\" hx-swap=\"none\" hx-indicator=\".htmx-indicator\">
<div class=\"flex flex-row justify-between items-center gap-3 bg-base-200 hover:bg-base-300 rounded-lg p-4 join-item\" data-order=\"
\"><div class=\"flex flex-row items-center gap-3 grow\"><!-- Drag handle -->
<div class=\"tooltip tooltip-right flex gap-3 cursor-move\" data-tip=\"Drag to reorder\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-grip-vertical\"><circle cx=\"9\" cy=\"12\" r=\"1\"></circle><circle cx=\"9\" cy=\"5\" r=\"1\"></circle><circle cx=\"9\" cy=\"19\" r=\"1\"></circle><circle cx=\"15\" cy=\"12\" r=\"1\"></circle><circle cx=\"15\" cy=\"5\" r=\"1\"></circle><circle cx=\"15\" cy=\"19\" r=\"1\"></circle></svg></div><input type=\"hidden\" name=\"location\" value=\"
\">
<!-- Marker icon -->
<span class=\"tooltip cursor-help\" data-tip=\"Has coordinates\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-map-pin\"><path d=\"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z\"></path> <circle cx=\"12\" cy=\"10\" r=\"3\"></circle></svg></span>
<span class=\"tooltip cursor-help\" data-tip=\"No coordinates set\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-map-pin-off tooltip\" data-tip=\"Location has no coordinates set\"><path d=\"M5.43 5.43A8.06 8.06 0 0 0 4 10c0 6 8 12 8 12a29.94 29.94 0 0 0 5-5\"></path> <path d=\"M19.18 13.52A8.66 8.66 0 0 0 20 10a8 8 0 0 0-8-8 7.88 7.88 0 0 0-3.52.82\"></path> <path d=\"M9.13 9.13A2.78 2.78 0 0 0 9 10a3 3 0 0 0 3 3 2.78 2.78 0 0 0 .87-.13\"></path> <path d=\"M14.9 9.25a3 3 0 0 0-2.15-2.16\"></path> <line x1=\"2\" x2=\"22\" y1=\"2\" y2=\"22\"></line></svg></span>
<!-- Clue indicator -->
<span class=\"tooltip text-neutral cursor-help\" data-tip=\"No clues\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-search-x\"><path d=\"m13.5 8.5-5 5\"></path><path d=\"m8.5 8.5 5 5\"></path><circle cx=\"11\" cy=\"11\" r=\"8\"></circle><path d=\"m21 21-4.3-4.3\"></path></svg></span>
<span class=\"tooltip cursor-help\" data-tip=\"Has clues\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-search\"><circle cx=\"11\" cy=\"11\" r=\"8\"></circle><path d=\"m21 21-4.3-4.3\"></path></svg></span>
<!-- Location code --><div class=\"badge badge-ghost basis-16 tooltip\" data-tip=\"Unique location code\"><code>
</code></div><!-- Location name --><a href=\"
\" class=\"link flex-grow\" hx-boost=\"true\" hx-swap=\"outerHTML\">
</a> 
<span class=\"badge\">
 pts</span>
</div></div>
</form></div><script>\nhtmx.onLoad(function(content) {\n    var sortables = content.querySelectorAll(\".sortable\");\n    for (var i = 0; i < sortables.length; i++) {\n      var sortable = sortables[i];\n      var sortableInstance = new Sortable(sortable, {\n          animation: 150,\n          ghostClass: 'blue-background-class',\n          handle: \".cursor-move\",\n\n          // Make the `.htmx-indicator` unsortable\n          filter: \".htmx-indicator\",\n          onMove: function (evt) {\n            return evt.related.className.indexOf('htmx-indicator') === -1;\n          },\n\n          // Disable sorting on the `end` event\n          onEnd: function (evt) {\n            this.option(\"disabled\", true);\n          }\n      });\n\n      // Re-enable sorting on the `htmx:afterSwap` event\n      sortable.addEventListener(\"htmx:afterSwap\", function() {\n        sortableInstance.option(\"disabled\", false);\n      });\n    }\n})\n</script>
<!-- Header --><div class=\"flex flex-col gap-3 md:flex-row justify-between items-center w-full p-5\"><h1 class=\"text-2xl font-bold\">Add a location</h1><!-- <button type=\"submit\" class=\"btn btn-primary\">Save</button> --></div><div class=\"flex flex-col w-full items-start\"><!-- Content --><form class=\"w-full\" method=\"post\"><div class=\"flex-grow container mx-auto p-5\"><div class=\"flex flex-row gap-5\"><div class=\"flex flex-col\"><div id=\"map\" class=\"w-96 h-96 rounded-lg shadow-lg mt-5\"></div><div class=\"form-control\"><label class=\"label cursor-pointer\"><span class=\"label-text\">Save map location</span> <input type=\"checkbox\" name=\"location\" class=\"checkbox checkbox-sm\"></label></div></div><input type=\"hidden\" name=\"latitude\"> <input type=\"hidden\" name=\"longitude\"><!-- Location Title and Content Textarea --><div class=\"flex-1\"><div class=\"mb-4\"><label for=\"name\" class=\"block text-base font-bold mb-2\">Location name</label> <input type=\"text\" id=\"name\" name=\"name\" class=\"input input-bordered w-full\" placeholder=\"Enter title\"></div><div class=\"mb-4\"><label for=\"content\" class=\"block text-base font-bold mb-2\">Content</label> <textarea id=\"content\" name=\"content\" rows=\"7\" class=\"textarea textarea-bordered w-full\" placeholder=\"Enter optional content here\"></textarea></div><button class=\"btn btn-primary\">Save</button></div></div></div></form></div>
<form hx-post=\"
\" hx-trigger=\"submit\" hx-swap=\"none\"><!-- Header --><div class=\"flex flex-col sm:flex-row gap-3 justify-between items-center w-full p-5\"><h1 class=\"text-2xl font-bold\">Editing <em>
</em></h1><div class=\"flex gap-3\"><div class=\"dropdown\"><div tabindex=\"0\" role=\"button\" class=\"btn btn-outline\">Downloads <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-chevron-down w-4 h-4\"><path d=\"m6 9 6 6 6-6\"></path></svg></div><ul tabindex=\"0\" class=\"dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow\"><h2 class=\"menu-title\">Check-In</h2><li><ul><!-- <li><a>Poster (PDF)</a></li> --><li><a href=\"
\" download=\"
\">QR Code (PNG)</a></li><li><a href=\"
\" download=\"
\">QR Code (SVG)</a></li></ul></li>
<h2 class=\"menu-title\">Check-Out</h2><li><ul><!-- <li><a>Poster (PDF)</a></li> --><li><a href=\"
\" download=\"
\">QR Code (PNG)</a></li><li><a href=\"
\" download=\"
\">QR Code (SVG)</a></li></ul></li>
</ul></div><button type=\"button\" class=\"btn btn-error\" onclick=\"confirm_delete_modal.showModal();\">Delete</button> <button type=\"submit\" class=\"btn btn-primary\">Save</button></div></div><div class=\"flex-grow mx-auto\"><div class=\"flex flex-col md:flex-row p-5 pt-0 gap-5 lg:gap-20\"><div class=\"flex flex-col flex-grow\"><div class=\"flex flex-col sm:flex-row gap-5 mb-5\"><!-- Location Title --><label for=\"name\" class=\"form-control w-full md:w-1/2\"><div class=\"label\"><span class=\"label-text font-bold\">Location name</span></div><input type=\"text\" id=\"name\" name=\"name\" class=\"input input-bordered w-full\" value=\"
\" placeholder=\"Enter title\"></label> 
<!-- Location Points --> <label for=\"points\" class=\"form-control w-full md:w-1/2\"><div class=\"label\"><span class=\"label-text font-bold\">Points</span> 
<span class=\"label-text-alt\"><span class=\"flex gap-1 badge badge-outline badge-sm tooltip cursor-help\" data-tip=\"Points are currently disabled\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-info w-3 h-3\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><path d=\"M12 16v-4\"></path><path d=\"M12 8h.01\"></path></svg> Disabled</span></span>
</div><input type=\"number\" id=\"points\" name=\"points\" class=\"input input-bordered w-full\" value=\"
\" placeholder=\"Enter points\"></label>
<input type=\"hidden\" name=\"points\" value=\"
\">
</div><!-- Content --><label for=\"content\" class=\"form-control w-full my-5\"><div class=\"label\"><span class=\"label-text font-bold\">Content</span> <label class=\"label-text-alt flex flex-row gap-3\">Preview <input type=\"checkbox\" class=\"toggle toggle-sm\" name=\"preview\" id=\"togglePreview\" class=\"checkbox\" onclick=\"previewMD()\"></label></div><textarea id=\"content\" name=\"content\" rows=\"7\" class=\"textarea textarea-bordered w-full font-mono\" placeholder=\"Enter optional content here\">
</textarea><div id=\"preview-content\" class=\"flex items-center justify-center min-h-48 border border-base-300 hidden card w-full bg-base-200 rounded-[var(--rounded-btn)] p-5\"></div><div class=\"label\"><span class=\"label-text-alt\">This is shown to players after checking in.</span> <span class=\"label-text-alt flex flex-row content-center gap-1\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-info w-5 h-5\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><path d=\"M12 16v-4\"></path><path d=\"M12 8h.01\"></path></svg> <span class=\"self-center\">This app uses Markdown for formatting content. <a class=\"link\" href=\"/admin/markdown\" target=\"blank\">Here's a quick guide</a>.</span></span></div></label><div class=\"w-full text-center md:text-start\"><button class=\"btn btn-primary w-4/5 mx-auto my-5 md:my-0 md:mx-0 md:w-auto\">Save</button></div></div><!-- Sidebar --><div class=\"flex flex-col\"><!-- Map --><div id=\"map\" class=\"w-full aspect-square md:w-[35vw] lg:w-96 rounded-lg shadow-lg mt-5\"></div><div class=\"form-control\"><label class=\"label cursor-pointer\"><span class=\"label-text\">Save map location</span> <input type=\"checkbox\" name=\"location\" class=\"checkbox checkbox-sm\" checked=\"checked\"></label></div><!-- Hidden inputs for form handling --><input type=\"hidden\" name=\"code\" value=\"
\"> <input type=\"hidden\" name=\"latitude\" value=\"
\"> <input type=\"hidden\" name=\"longitude\" value=\"
\"> 
<!-- Clues --> <div class=\"label\"><span class=\"label-text font-bold flex gap-3 items-center\">Clues</span></div><div>
<div class=\"prose my-5 mx-3\"><blockquote class=\"mb-0\"><div class=\"flex gap-3 justify-end\">
 <button type=\"button\" class=\"btn btn-xs btn-ghost\" onclick=\"this.previousElementSibling.classList.toggle(&#39;hidden&#39;)\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-pencil w-4 h-4\"><path d=\"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z\"></path><path d=\"m15 5 4 4\"></path></svg> Edit</button> <button type=\"button\" class=\"btn btn-xs btn-ghost text-error\" onclick=\"this.closest(&#39;div&#39;).remove()\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-delete w-4 h-4\"><path d=\"M10 5a2 2 0 0 0-1.344.519l-6.328 5.74a1 1 0 0 0 0 1.481l6.328 5.741A2 2 0 0 0 10 19h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z\"></path><path d=\"m12 9 6 6\"></path><path d=\"m18 9-6 6\"></path></svg> Delete</button></div></blockquote></div>
</div>
</div></div></div></form><dialog id=\"confirm_delete_modal\" class=\"modal\"><div class=\"modal-box prose outline outline-1 outline-offset-1 outline-error\"><h3 class=\"text-lg font-bold\">Delete this location?</h3><p class=\"pt-4\">You are about to delete this location. Are you sure?</p><div class=\"modal-action\"><button type=\"button\" class=\"btn\" onclick=\"confirm_delete_modal.close()\">Nevermind</button> <button type=\"button\" class=\"btn btn-error\" hx-delete=\"
\" hx-trigger=\"click\" onclick=\"confirm_delete_modal.close()\">Delete</button></div></div></dialog><script>\n// Delete modal\nconst confirm_delete_modal = document.getElementById('confirm_delete_modal');\n\n\n</script><script>\n  function previewMD() {\n    var checkBox = document.getElementById(\"togglePreview\");\n    var textarea = document.getElementById(\"content\");\n    var preview = document.getElementById(\"preview-content\");\n\n    if (checkBox.checked == true){\n      textarea.classList.add(\"hidden\");\n      preview.classList.remove(\"hidden\");\n      preview.setAttribute(\"aria-busy\", true)\n      preview.innerHTML = \"<span class='loading loading-ring loading-lg'></span>\"\n\n      var xhr = new XMLHttpRequest();\n      xhr.open(\"POST\", '/admin/markdown/preview', true);\n      xhr.setRequestHeader('Content-Type', 'application/json');\n      xhr.send(JSON.stringify({\n        markdown: textarea.value\n      }));\n\n      xhr.onreadystatechange = (e) => {\n        preview.innerHTML = xhr.response\n      }\n    } else {\n      textarea.classList.remove(\"hidden\");\n      preview.classList.add(\"hidden\");\n      preview.innerHTML = null\n    }\n  }\n</script>
<script>\n(function () {\n  let map; // Store the map instance globally within the IIFE\n  let marker; // Store the marker instance globally within the IIFE\n\n  function initializeMapAndTextarea() {\n    // --- TEXTAREA AUTO-RESIZE LOGIC ---\n    const tx = document.getElementsByTagName(\"textarea\");\n    for (let i = 0; i < tx.length; i++) {\n      tx[i].setAttribute(\"style\", \"height:\" + (tx[i].scrollHeight) + \"px;overflow-y:hidden;\");\n      tx[i].addEventListener(\"input\", function() {\n        this.style.height = 'auto';\n        this.style.height = (this.scrollHeight) + \"px\";\n      });\n    }\n\n    // --- MAPBOX INITIALIZATION LOGIC ---\n    let coords = [170.5111643, -45.8650509];\n    let zoom = 14;\n\n    // Check if longitude and latitude fields are set\n    if (document.querySelector('input[name=\"longitude\"]').value != \"\" && document.querySelector('input[name=\"latitude\"]').value != \"\") {\n      coords = [\n        parseFloat(document.querySelector('input[name=\"longitude\"]').value),\n        parseFloat(document.querySelector('input[name=\"latitude\"]').value)\n      ];\n      zoom = 16;\n    }\n\n    // Destroy existing map instance if it exists\n    if (map) {\n      map.remove();\n      map = null; // Explicitly set to null to clear reference\n    }\n\n    // Set the Mapbox access token\n    mapboxgl.accessToken = document.getElementById('mapbox_key').dataset.key;\n\n    // Determine map style based on color scheme\n    const style = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches\n      ? 'mapbox://styles/nathanhollows/cl9w3nxff002m14sy9fco4vnr'\n      : 'mapbox://styles/nathanhollows/clszboe2y005i01oid8ca37jm';\n\n    // Create the map\n    map = new mapboxgl.Map({\n      container: 'map',\n      style: style,\n      center: coords,\n      zoom: zoom\n    });\n\n    // Create and place marker\n    marker = new mapboxgl.Marker()\n      .setLngLat(coords)\n      .addTo(map);\n\n    // Update marker position on map drag\n    map.on('drag', function() {\n      const center = map.getCenter();\n      marker.setLngLat(center);\n      document.querySelector('input[name=\"latitude\"]').value = center.lat;\n      document.querySelector('input[name=\"longitude\"]').value = center.lng;\n      document.querySelector('input[name=\"location\"]').checked = true;\n    });\n\n    // Update marker position on map zoom\n    map.on('zoom', function() {\n      const center = map.getCenter();\n      marker.setLngLat(center);\n    });\n\n    // Add event listener for location saving switch\n    document.querySelector('input[name=\"switch\"]').addEventListener('change', function(e) {\n      if (e.target.checked) {\n        const center = map.getCenter();\n        marker.setLngLat(center);\n        document.querySelector('input[name=\"latitude\"]').value = center.lat;\n        document.querySelector('input[name=\"longitude\"]').value = center.lng;\n      } else {\n        document.querySelector('input[name=\"latitude\"]').value = \"\";\n        document.querySelector('input[name=\"longitude\"]').value = \"\";\n      }\n    });\n  }\n\n  // Initialize map and textarea on page load\n  initializeMapAndTextarea();\n\n})();\n</script>
